// @ts-nocheck

import { ChatPage, EndpointCategory, WKApp, Menus } from "@tsdaodao/base";
import { ContactsList } from "@tsdaodao/contacts";
import React from "react";
import "./index.css";
import AppLayout from "../Layout";
import { WKSDK } from "wukongimjssdk";

function App() {
  registerMenus();
  return <AppLayout />;
}

async function registerMenus() {
  WKSDK.shared().conversationManager.addConversationListener(() => {
    WKApp.menus.refresh();
  });

  WKApp.endpointManager.setMethod(
    "menus.friendapply.change",
    () => {
      WKApp.menus.refresh();
    },
    {
      category: EndpointCategory.friendApplyDataChange,
    }
  );

  WKApp.menus.register(
    "chat",
    (_context) => {
      const m = new Menus(
        "chat",
        "/",
        "会话",
        (
          <svg
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            p-id="50388"
            width="20"
            height="20"
          >
            <path
              d="M965.818182 635.112727v-368.64c0-132.561455-59.950545-196.980364-183.296-196.980363H262.842182c-123.298909 0-183.249455 64.418909-183.249455 197.026909v368.593454c0 132.608 59.950545 197.026909 183.249455 197.026909h109.102545a46.545455 46.545455 0 0 1 46.545455 46.545455v47.336727c70.795636-32.349091 186.414545-77.544727 302.731636-90.344727a46.266182 46.266182 0 0 1 17.780364-3.537455c104.634182 0 226.816-51.572364 226.816-197.026909zM782.522182 22.946909c150.388364 0 229.841455 85.597091 229.841454 243.572364v368.593454c0 157.975273-123.019636 243.572364-273.361454 243.572364h43.52c-191.441455 0-410.530909 122.368-410.530909 122.368v-122.414546H262.795636c-150.341818 0-229.794909-85.550545-229.794909-243.525818v-368.64C33.047273 108.590545 112.500364 22.993455 262.842182 22.993455h519.68z m-8.610909 354.304a58.088727 58.088727 0 1 1-0.093091 116.177455 58.088727 58.088727 0 0 1 0.093091-116.177455z m-502.365091 0a58.088727 58.088727 0 1 1-0.093091 116.177455 58.088727 58.088727 0 0 1 0.093091-116.177455z m251.205818 0a58.088727 58.088727 0 1 1-0.093091 116.177455 58.088727 58.088727 0 0 1 0.093091-116.177455z"
              fill="rgba(255,255,255,0.6)"
              p-id="50389"
            ></path>
          </svg>
        ),
        (
          <svg
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            p-id="50388"
            width="20"
            height="20"
          >
            <path
              d="M965.818182 635.112727v-368.64c0-132.561455-59.950545-196.980364-183.296-196.980363H262.842182c-123.298909 0-183.249455 64.418909-183.249455 197.026909v368.593454c0 132.608 59.950545 197.026909 183.249455 197.026909h109.102545a46.545455 46.545455 0 0 1 46.545455 46.545455v47.336727c70.795636-32.349091 186.414545-77.544727 302.731636-90.344727a46.266182 46.266182 0 0 1 17.780364-3.537455c104.634182 0 226.816-51.572364 226.816-197.026909zM782.522182 22.946909c150.388364 0 229.841455 85.597091 229.841454 243.572364v368.593454c0 157.975273-123.019636 243.572364-273.361454 243.572364h43.52c-191.441455 0-410.530909 122.368-410.530909 122.368v-122.414546H262.795636c-150.341818 0-229.794909-85.550545-229.794909-243.525818v-368.64C33.047273 108.590545 112.500364 22.993455 262.842182 22.993455h519.68z m-8.610909 354.304a58.088727 58.088727 0 1 1-0.093091 116.177455 58.088727 58.088727 0 0 1 0.093091-116.177455z m-502.365091 0a58.088727 58.088727 0 1 1-0.093091 116.177455 58.088727 58.088727 0 0 1 0.093091-116.177455z m251.205818 0a58.088727 58.088727 0 1 1-0.093091 116.177455 58.088727 58.088727 0 0 1 0.093091-116.177455z"
              fill="#ffffff"
              p-id="50389"
            ></path>
          </svg>
        )
      );
      let badge = 0;

      for (const conversation of WKSDK.shared().conversationManager
        .conversations) {
        badge += conversation.unread;
      }

      m.badge = badge;

      if ((window as any).__POWERED_ELECTRON__) {
        (window as any).ipc.send("conversation-anager-unread-count", badge);
      }

      return m;
    },
    1000
  );

  // 获取好友未申请添加数量
  // let unreadCount = 0;
  if (WKApp.loginInfo.isLogined()) {
    WKApp.apiClient.get(`/user/reddot/friendApply`).then((res) => {
      // unreadCount = res.count;
      WKApp.mittBus.emit("friend-applys-unread-count", res.count);
      WKApp.loginInfo.setStorageItem(
        `${WKApp.loginInfo.uid}-friend-applys-unread-count`,
        res.count
      );
      WKApp.menus.refresh();
    });
  }

  WKApp.menus.register(
    "contacts",
    (param) => {
      const m = new Menus(
        "contacts",
        "/contacts",
        "通讯录",
        (
          <svg
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            p-id="54173"
            width="20"
            height="20"
          >
            <path
              d="M756.483413 988.050773v1.201494c0.477867 16.861867 12.67712 30.027093 27.7504 30.027093 15.069867 0 27.26912-13.1584 27.746987-30.027093l0.3584-10.407254h0.477867c0.48128-7.656107 0.600747-14.353067 0.600746-20.811093 0-180.616533-100.22912-340.54144-255.245653-407.3984l-17.343147-7.533227 15.305387-11.127466c74.277547-53.828267 118.654293-143.53408 118.654293-240.05632C674.430293 132.83328 555.0592 3.413333 408.17664 3.413333 261.41696 3.413333 142.045867 132.83328 142.045867 291.915093c0 96.52224 44.373333 186.238293 118.654293 240.05632l15.3088 11.127467-17.343147 7.533227C103.645867 617.61536 3.413333 777.540267 3.413333 958.03392c0 6.331733 0.238933 13.028693 0.7168 20.811093h0.720214l0.119466 10.76224c0 17.104213 12.4416 30.979413 27.866454 30.979414 15.3088 0 27.869867-13.8752 27.869866-30.979414 0-0.23552-0.119467-0.7168-0.119466-1.19808-0.119467-0.600747-0.119467-1.201493-0.238934-1.672533a309.326507 309.326507 0 0 1-1.314133-28.822187c0-100.478293 36.23936-195.085653 102.147413-266.257066 65.911467-71.29088 153.818453-110.52032 247.360854-110.52032 93.535573 0 181.326507 39.345493 247.473493 110.639786 65.78176 71.168 102.150827 165.659307 102.150827 266.257067 0 10.519893-0.720213 20.811093-1.437014 29.535573-0.24576 0.119467-0.24576 0.361813-0.24576 0.48128M198.618453 292.15744c0-124.39552 94.132907-225.706667 209.677654-225.706667 115.664213 0 209.677653 101.19168 209.677653 225.706667s-94.132907 225.703253-209.677653 225.703253c-115.54816 0-209.677653-101.31456-209.677654-225.703253m517.31456 277.13536c69.7344 8.25344 132.765013 44.4928 177.98144 101.7856 45.09696 57.173333 69.853867 132.29056 69.853867 211.3536 0 17.462613 12.683947 31.464107 28.35456 31.464107 15.189333 0 27.630933-13.284693 28.228267-30.262614l0.119466-0.959146c0-0.23552 0-0.354987 0.119467-0.477867-0.119467-150.234453-83.490133-283.11552-212.4288-338.500267l-17.462613-7.533226 15.43168-11.127467c61.719893-44.61568 98.679467-119.016107 98.679466-199.389867 0-111.12448-69.137067-206.332587-168.413866-232.40704l-0.7168 0.23552-2.757974-0.23552c-0.597333 0-1.068373-0.119467-1.672533-0.238933-0.23552 0-0.477867-0.119467-0.7168-0.119467-15.906133 0.119467-28.70272 14.472533-28.70272 32.06144 0 15.786667 10.287787 29.067947 24.521387 31.45728l1.317546 0.238934 1.19808 0.597333c1.317547 0.600747 3.47136 1.32096 6.10304 2.034347 0.597333 0.119467 1.071787 0.3584 1.071787 0.3584 65.191253 23.92064 108.96384 89.705813 108.96384 163.867306 0 82.76992-54.418773 153.818453-129.778347 169.728l-1.201493 0.720214-2.5088 0.238933c-17.824427 1.19808-31.81568 17.4592-31.81568 37.075627 0 20.097707 14.353067 36.36224 32.53248 37.20192l2.392747 0.11264 1.307306 0.720213"
              fill="rgba(255,255,255,0.6)"
              p-id="54174"
            ></path>
          </svg>
        ),
        (
          <svg
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            p-id="54173"
            width="20"
            height="20"
          >
            <path
              d="M756.483413 988.050773v1.201494c0.477867 16.861867 12.67712 30.027093 27.7504 30.027093 15.069867 0 27.26912-13.1584 27.746987-30.027093l0.3584-10.407254h0.477867c0.48128-7.656107 0.600747-14.353067 0.600746-20.811093 0-180.616533-100.22912-340.54144-255.245653-407.3984l-17.343147-7.533227 15.305387-11.127466c74.277547-53.828267 118.654293-143.53408 118.654293-240.05632C674.430293 132.83328 555.0592 3.413333 408.17664 3.413333 261.41696 3.413333 142.045867 132.83328 142.045867 291.915093c0 96.52224 44.373333 186.238293 118.654293 240.05632l15.3088 11.127467-17.343147 7.533227C103.645867 617.61536 3.413333 777.540267 3.413333 958.03392c0 6.331733 0.238933 13.028693 0.7168 20.811093h0.720214l0.119466 10.76224c0 17.104213 12.4416 30.979413 27.866454 30.979414 15.3088 0 27.869867-13.8752 27.869866-30.979414 0-0.23552-0.119467-0.7168-0.119466-1.19808-0.119467-0.600747-0.119467-1.201493-0.238934-1.672533a309.326507 309.326507 0 0 1-1.314133-28.822187c0-100.478293 36.23936-195.085653 102.147413-266.257066 65.911467-71.29088 153.818453-110.52032 247.360854-110.52032 93.535573 0 181.326507 39.345493 247.473493 110.639786 65.78176 71.168 102.150827 165.659307 102.150827 266.257067 0 10.519893-0.720213 20.811093-1.437014 29.535573-0.24576 0.119467-0.24576 0.361813-0.24576 0.48128M198.618453 292.15744c0-124.39552 94.132907-225.706667 209.677654-225.706667 115.664213 0 209.677653 101.19168 209.677653 225.706667s-94.132907 225.703253-209.677653 225.703253c-115.54816 0-209.677653-101.31456-209.677654-225.703253m517.31456 277.13536c69.7344 8.25344 132.765013 44.4928 177.98144 101.7856 45.09696 57.173333 69.853867 132.29056 69.853867 211.3536 0 17.462613 12.683947 31.464107 28.35456 31.464107 15.189333 0 27.630933-13.284693 28.228267-30.262614l0.119466-0.959146c0-0.23552 0-0.354987 0.119467-0.477867-0.119467-150.234453-83.490133-283.11552-212.4288-338.500267l-17.462613-7.533226 15.43168-11.127467c61.719893-44.61568 98.679467-119.016107 98.679466-199.389867 0-111.12448-69.137067-206.332587-168.413866-232.40704l-0.7168 0.23552-2.757974-0.23552c-0.597333 0-1.068373-0.119467-1.672533-0.238933-0.23552 0-0.477867-0.119467-0.7168-0.119467-15.906133 0.119467-28.70272 14.472533-28.70272 32.06144 0 15.786667 10.287787 29.067947 24.521387 31.45728l1.317546 0.238934 1.19808 0.597333c1.317547 0.600747 3.47136 1.32096 6.10304 2.034347 0.597333 0.119467 1.071787 0.3584 1.071787 0.3584 65.191253 23.92064 108.96384 89.705813 108.96384 163.867306 0 82.76992-54.418773 153.818453-129.778347 169.728l-1.201493 0.720214-2.5088 0.238933c-17.824427 1.19808-31.81568 17.4592-31.81568 37.075627 0 20.097707 14.353067 36.36224 32.53248 37.20192l2.392747 0.11264 1.307306 0.720213"
              fill="#ffffff"
              p-id="54174"
            ></path>
          </svg>
        )
      );
      m.badge = WKApp.shared.getFriendApplysUnreadCount();
      return m;
    },
    4000
  );

  WKApp.route.register("/", () => {
    return <ChatPage />;
  });

  WKApp.route.register("/contacts", () => {
    return <ContactsList />;
  });
}

export default App;
